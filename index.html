<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <script src="./Cesium.js"></script>
    <link href="./Widgets/widgets.css" rel="stylesheet">
    <link rel="stylesheet" href="./index.css">
    <script type="text/javascript"
        src="http://api.map.baidu.com/api?v=1.0&type=webgl&ak=krkDooFgQhqdEGDXsDoDbwFrmiTw2Chy"></script>
</head>

<body>
    <header id="header">
        <img class="img" src="./161044117538238 (1).png">
        <span class="
        title">Cesium内涝视频监测</span>
        <span class="weather">赣州市:晴转多云</span>
        <div class="btn-wrap">
            <button class="btn" type="button" onclick="Rain()">降雨</button>
            <button class="btn" onclick="Merge()">视频融合</button>
            <button class="btn" onclick="Video()">监控</button>
            <button class="btn" onclick="baiduMap()">地图定位</button>
        </div>
    </header>
    <div class="wrap">
        <div id="cesiumContainer">
        </div>
        <div id="mapContainer" class="mapContainer">
            
        </div>
        <span class="close" onclick="Close()">X</span>
    </div>
    <video id="trailer" muted autoplay loop crossorigin controls style="display: none;">
        <source src="./video.mp4" type="video/mp4">
    </video>
    <script>
        var pinBuilder = new Cesium.PinBuilder();
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJkZjg5NmQzMi1lN2M3LTQxZTktOTAyYS01MDFkM2RjYTgyOGMiLCJpZCI6MzQ2NjgsImlhdCI6MTYwMDY4Mzg0OX0.vv0m2W-E8Vmi3VleFtwfTRBYdSoNdBCS-COnZVgN3Zc'
        //界面设置
        var viewer = new Cesium.Viewer('cesiumContainer', {
            animation: false, //是否显示动画控件
            baseLayerPicker: false, //是否显示图层选择控件
            geocoder: true, //是否显示地名查找控件
            timeline: false, //是否显示时间线控件
            sceneModePicker: true, //是否显示投影方式控件
            navigationHelpButton: false, //是否显示帮助信息控件
            infoBox: true, //是否显示点击要素之后显示的信息
            homeButton: false,
            sceneModePicker: false,

        })
        //初始化位置
        viewer.camera.setView({
            destination: { x: -2663021.6477466617, y: 5063378.237707626, z: 2814467.9981729123 },
            orientation: {
                heading: 0.7705635966568973,
                pitch: -0.2890027802058879,
                roll: 0.0019378587337719466
            }
        });

        //加载天地图
        var layer = new Cesium.WebMapTileServiceImageryProvider({
            url: "http://t0.tianditu.gov.cn/img_w/wmts?tk=ffd0e61d238085c62d54bf80db7b8a72",
            layer: "img",
            style: "default",
            tileMatrixSetID: "w",
            format: "tiles",
            maximumLevel: 18
        });
        viewer.imageryLayers.addImageryProvider(layer);
        var layer1 = new Cesium.WebMapTileServiceImageryProvider({
            url: "http://t0.tianditu.gov.cn/cia_w/wmts?tk=ffd0e61d238085c62d54bf80db7b8a72",
            layer: "cia",
            style: "default",
            tileMatrixSetID: "w",
            format: "tiles",
            maximumLevel: 18
        });
        viewer.imageryLayers.addImageryProvider(layer1);
        //加载地形
        var terrainProvider = new Cesium.CesiumTerrainProvider({
            url: 'http://localhost:3000'
        });
        viewer.terrainProvider = terrainProvider;
        viewer._cesiumWidget._creditContainer.style.display = "none";
        //  传入坐标，动态创建图标
        var hospitalPin = Cesium.when(
            pinBuilder.fromMakiIconId("camera", Cesium.Color.RED, 48),
            function (canvas) {
                return viewer.entities.add({
                    name: "内涝点",
                    position: { x: -2664013.7547220006, y: 5060055.114255643, z: 2815601.347413798 },
                    billboard: {
                        image: canvas.toDataURL(),
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                    },
                });
            }

        );
        var hospitalPin2 = Cesium.when(
            pinBuilder.fromMakiIconId("camera", Cesium.Color.RED, 48),
            function (canvas) {
                return viewer.entities.add({
                    name: "内涝点",
                    position: { x: -2663117.8069646065, y: 5060598.819943117, z: 2815489.0559819075 },
                    billboard: {
                        image: canvas.toDataURL(),
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                    },
                });
            }

        );
        var hospitalPin3 = Cesium.when(
            pinBuilder.fromMakiIconId("camera", Cesium.Color.RED, 48),
            function (canvas) {
                return viewer.entities.add({
                    name: "内涝点",
                    position: { x: -2663395.8347345954, y: 5059946.813925204, z: 2816384.582437113 },
                    billboard: {
                        image: canvas.toDataURL(),
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                    },
                });
            }

        );
        var handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        console.log(handler)
        handler.setInputAction(function (click) {

            var pick = viewer.scene.pick(click.position);
            //选中某模型   pick选中的对象
            if (pick && pick.id) {

                var div = document.getElementById("cesiumContainer");
                var Vdiv = document.createElement("div");
                Vdiv.id = "vid";
                //   Vdiv.src = "http://172.16.96.216:5000/index"
                //   console.log(Vdiv);
                var img = document.createElement("img");
                img.id = "img";
                img.src = "http://172.16.96.216:5000/video_feed"
                Vdiv.appendChild(img);
                div.appendChild(Vdiv);

                console.log(2)


            }
            else {
                let reid = document.getElementById('vid');
                if (reid) {
                    reid.parentNode.removeChild(reid);
                }
            }
            // return false

        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        var entityPolygon = null;
        var points = null;
        var drawingMode = 'polygon';
        var activeShapePoints = [];
        var activeShape;
        var floatingPoint;

        var activeShapePoints = [];
        var p1 = new Cesium.Cartesian3(-2663689.7462353962, 5060007.86356857, 2816023.838152685);
        var p2 = new Cesium.Cartesian3(-2663664.711211369, 5060006.791919193, 2816049.6205705022);
        var p3 = new Cesium.Cartesian3(-2663689.884455386, 5059980.319678125, 2816077.696495478);
        var p4 = new Cesium.Cartesian3(-2663717.898198316, 5059978.2221952835, 2816051.782414917);
        activeShapePoints.push(p1);
        activeShapePoints.push(p2);
        activeShapePoints.push(p3);
        activeShapePoints.push(p4);
        // console.log(activeShapePoints)
        var videoElement = document.getElementById("trailer")
        videoElement.play();
        var shape = viewer.entities.add({
            polygon: {
                hierarchy: activeShapePoints,
                material: videoElement
            }
        })
        // viewer.zoomTo(shape);
        //添加小车
        // 小车旋转角度
        // 小车的速度
        // let speed = 10;
        // // 速度矢量
        // let speedVector = new Cesium.Cartesian3();
        let scene = viewer.scene;
        // 起始位置
        let position = { x: -2663721.684761186, y: 5059957.13301249, z: 2816086.2946636667 };

        // 用于设置小车方向

        var hpr = new Cesium.HeadingPitchRoll();

        let fixedFrameTransforms = Cesium.Transforms.localFrameToFixedFrameGenerator('north', 'west');
        // 添加小车模型
        let carPrimitive = scene.primitives.add(Cesium.Model.fromGltf({
            url: './SampleData/models/CesiumMilkTruck/CesiumMilkTruck.glb',
            modelMatrix: Cesium.Transforms.headingPitchRollToFixedFrame(position, hpr, Cesium.Ellipsoid.WGS84, fixedFrameTransforms),
            minimumPixelSize: 30
        }));
        let position2 = { x: -2663747.0262933653, y: 5059932.372397399, z: 2816111.8206613213 };
        var hpr2 = new Cesium.HeadingPitchRoll();
        let fixedFrameTransforms2 = Cesium.Transforms.localFrameToFixedFrameGenerator('north', 'west');

        let carPrimitive2 = scene.primitives.add(Cesium.Model.fromGltf({
            url: './SampleData/models/CesiumMilkTruck/CesiumMilkTruck.glb',
            modelMatrix: Cesium.Transforms.headingPitchRollToFixedFrame(position2, hpr2, Cesium.Ellipsoid.WGS84, fixedFrameTransforms2),
            minimumPixelSize: 30
        }));
        let position3 = { x: -2663644.304530702, y: 5060049.189458888, z: 2815989.6943857493 };
        var hpr3 = new Cesium.HeadingPitchRoll();
        let fixedFrameTransforms3 = Cesium.Transforms.localFrameToFixedFrameGenerator('north', 'west');

        let carPrimitive3 = scene.primitives.add(Cesium.Model.fromGltf({
            url: './SampleData/models/CesiumMilkTruck/CesiumMilkTruck.glb',
            modelMatrix: Cesium.Transforms.headingPitchRollToFixedFrame(position3, hpr3, Cesium.Ellipsoid.WGS84, fixedFrameTransforms3),
            minimumPixelSize: 30
        }));

        const ps1 = { x: -2666889.903463367, y: 5057804.524754993, z: 2816642.0654018456 };
        const ps2 = { x: -2666344.712346242, y: 5058049.8141218955, z: 2816717.248682426 };
        const ps3 = { x: -2667065.046786238, y: 5057715.679295137, z: 2816636.3431803053 };
        //查看位置
        // handler.setInputAction(function (event) {
        //     //1.椭球面坐标:获取当前点击视线与椭球面相交处的坐标，在加载地形的场景上获取的坐标有误差
        //     //var earthPosition = viewer.camera.pickEllipsoid(event.position,viewer.scene.globe.ellipsoid);

        //     //2.场景坐标:获取场景中任意点击处的对应的世界坐标，需要开启“地形深度检测”（在未开启“地形深度检测”的情况下只能在3DTile上准确获取空间坐标，开启“地形深度检测”后，viewer.scene.pickPosition 也能在非3DTile上准确获取坐标）
        //     viewer.scene.globe.depthTestAgainstTerrain = true;
        //     var earthPosition = viewer.scene.pickPosition(event.position);
        //     console.log(earthPosition)
        //     //3.地标坐标：获取点击处地球表面的世界坐标，不包括模型、倾斜摄影表面
        //     // var ray = viewer.camera.getPickRay(event.position);
        //     // var earthPosition = viewer.scene.globe.pick(ray, viewer.scene);

        //     if (Cesium.defined(earthPosition)) {

        //     }
        // }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        //控制小车移动
        let s1, s2, s3;
        let flag = false;
        createCar = (ran1, ran2) => {
            s1 = setInterval(() => {
                let radian = Cesium.Math.toRadians(ran1);
                let speed = 2;
                let speedVector = new Cesium.Cartesian3();
                hpr.heading = radian;
                speedVector = Cesium.Cartesian3.multiplyByScalar(Cesium.Cartesian3.UNIT_X, speed, speedVector);
                positions = Cesium.Matrix4.multiplyByPoint(carPrimitive.modelMatrix, speedVector, position);
                Cesium.Transforms.headingPitchRollToFixedFrame(positions, hpr, Cesium.Ellipsoid.WGS84, fixedFrameTransforms, carPrimitive.modelMatrix);
            }, 100);
            s2 = setInterval(() => {
                let radian = Cesium.Math.toRadians(ran1);
                hpr2.heading = radian;
                let speed = 2;
                let speedVector = new Cesium.Cartesian3();
                speedVector = Cesium.Cartesian3.multiplyByScalar(Cesium.Cartesian3.UNIT_X, speed, speedVector);
                positions2 = Cesium.Matrix4.multiplyByPoint(carPrimitive2.modelMatrix, speedVector, position2);
                Cesium.Transforms.headingPitchRollToFixedFrame(positions2, hpr2, Cesium.Ellipsoid.WGS84, fixedFrameTransforms2, carPrimitive2.modelMatrix);
            }, 100);
            s3 = setInterval(() => {
                let radian = Cesium.Math.toRadians(ran2);
                hpr3.heading = radian;
                let speed = 2;
                let speedVector = new Cesium.Cartesian3();
                speedVector = Cesium.Cartesian3.multiplyByScalar(Cesium.Cartesian3.UNIT_X, speed, speedVector);
                positions3 = Cesium.Matrix4.multiplyByPoint(carPrimitive3.modelMatrix, speedVector, position3);

                Cesium.Transforms.headingPitchRollToFixedFrame(positions3, hpr3, Cesium.Ellipsoid.WGS84, fixedFrameTransforms3, carPrimitive3.modelMatrix);
            }, 100);
        }
        //232 52
        var ran1 = 232;
        var ran2 = 52;
        createCar(ran1, ran2)
        //取消定时器
        clearIn = () => {
            clearInterval(s1)
            clearInterval(s2)
            clearInterval(s3)

        }
        setInterval(() => {
            clearIn();
            ran1 = ran1 + 180;
            ran2 = ran2 + 180;
            createCar(ran1, ran2);
        }, 8000);
        //   setInterval(() => {
        //     clearInterval(s1);
        //     clearInterval(s2);
        //     clearInterval(s3);
        //     // let modelMatrix = Cesium.Transforms.headingPitchRollToFixedFrame(position,hpr,Cesium.Ellipsoid.WGS84,fixedFrameTransforms)
        //     // carPrimitive._modelMatrix = modelMatrix
        //     // console.log(carPrimitive)
        //     console.log(position3)
        //     position3 = ps3;
        //     console.log(ps3)
        //     console.log(position3)
        //     createCar();
        //   }, 5000);

        //定义下雨场景 着色器\\
        function FS_Rain() {
            return "uniform sampler2D colorTexture;\n\
                    varying vec2 v_textureCoordinates;\n\
                    \n\
                    float hash(float x){\n\
                          return fract(sin(x*23.3)*13.13);\n\
                    }\n\
                    \n\
                    void main(void){\n\
                    \n\
                        float time = czm_frameNumber / 60.0;\n\
                        vec2 resolution = czm_viewport.zw;\n\
                        \n\
                        vec2 uv=(gl_FragCoord.xy*2.-resolution.xy)/min(resolution.x,resolution.y);\n\
                        vec3 c=vec3(.6,.7,.8);\n\
                        \n\
                        float a=-.4;\n\
                        float si=sin(a),co=cos(a);\n\
                        uv*=mat2(co,-si,si,co);\n\
                        uv*=length(uv+vec2(0,4.9))*.3+1.;\n\
                        \n\
                        float v=1.-sin(hash(floor(uv.x*100.))*2.);\n\
                        float b=clamp(abs(sin(20.*time*v+uv.y*(5./(2.+v))))-.95,0.,1.)*20.;\n\
                        c*=v*b; \n\
                        \n\
                        gl_FragColor = mix(texture2D(colorTexture, v_textureCoordinates), vec4(c,1), 0.5);  \n\
                    }\n\
             ";
        }
        var collection = viewer.scene.postProcessStages;
        function Cancel() {

            collection.removeAll();
            console.log(collection);
        }
        function Rain() {
            Cancel();
            var fs_rain = FS_Rain();
            var snow = new Cesium.PostProcessStage({
                name: 'czm_rain',
                fragmentShader: fs_rain
            });
            viewer.scene.skyAtmosphere.hueShift = -0.8;
            viewer.scene.skyAtmosphere.saturationShift = -0.7;
            viewer.scene.skyAtmosphere.brightnessShift = -0.33;
            viewer.scene.fog.density = 0.001;
            viewer.scene.fog.minimumBrightness = 0.8;
            collection.add(snow)
        }
        function Merge() {
            viewer.camera.setView({
                destination: { x: -2663933.2620123085, y: 5060365.413528941, z: 2816272.8409385844 }
            })
        }
        //定位监控口
        function Video() {
            viewer.zoomTo(hospitalPin);
            console.log(hospitalPin)
            console.log(1)
        }
        //显示二维地图
        function baiduMap() {
            let baiduMap = document.getElementsByClassName("mapContainer");
            let close = document.getElementsByClassName("close")
            // console.log(baiduMap);
            baiduMap[0].classList.add("show");
            close[0].classList.add("show");
        }
        function Close() {
            // console.log('一点击')
            let baiduMap = document.getElementsByClassName("mapContainer");
            let close = document.getElementsByClassName("close")
                baiduMap[0].classList.remove("show");
             close[0].classList.remove("show");     
        }
        //设置二维地图
        var map = new BMapGL.Map("mapContainer");          // 创建地图实例 
            var point = new BMapGL.Point(117.779651, 26.387905);  // 创建点坐标 
            map.centerAndZoom(point, 15);                 // 初始化地图，设置中心点坐标和地图级别
            let neilao1 = new BMapGL.Point(117.777046, 26.369197);
            let neilao2 = new BMapGL.Point(117.767178, 26.368468);
            let neilao3 = new BMapGL.Point(117.772262, 26.377321);
            var marker = new BMapGL.Marker(neilao1);
            var marker2 = new BMapGL.Marker(neilao2);
            var marker3 = new BMapGL.Marker(neilao3);
            map.addOverlay(marker);
            map.addOverlay(marker2);
            map.addOverlay(marker3);
            let opts = {
                width: 200,
                height: 50,
                title: '内涝监控点'
            }
            var infoWindow = new BMapGL.InfoWindow("地址：三明市如意湖湿地公园", opts);
            var infoWindow2 = new BMapGL.InfoWindow("地址：水上乐园便民超市", opts);
            var infoWindow3 = new BMapGL.InfoWindow("地址：金州美一城", opts);

            // 创建信息窗口对象 
            marker.addEventListener("click", function () {
                map.openInfoWindow(infoWindow, neilao1); //开启信息窗口
            });
            marker2.addEventListener("click", function () {
                map.openInfoWindow(infoWindow2, neilao2); //开启信息窗口
            });
            marker3.addEventListener("click", function () {
                map.openInfoWindow(infoWindow3, neilao3); //开启信息窗口
            });
            map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
            map.setHeading(64.5);   //设置地图旋转角度
            map.setTilt(73);       //设置地图的倾斜角度
    </script>
</body>

</html>